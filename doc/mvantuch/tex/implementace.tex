
\chapter{Implementace portálu v Drupalu}
\label{chap:implementace-drupal}

Tady popsat co přesně bylo uděláno v rámci implementace a proč to bylo uděláno. Proč bylo důležité aktualizovat na Drupal 7 a co to s sebou přineslo za změny.
\section{Aktualizace Drupal 6 na Drupal 7}
Výhody Drupal 7 nad Drupalem 6
Porovnání dostupných verzí mezi Drupalem 6 a 7

\begin{table}
  \caption{Porovnání verzí modulů mezi Drupalem 6 a 7}
  \begin{tabular}{ | p{5cm} | p{2.5cm} | p{2.5cm} | c | }
    \hline 
    Jméno modulu & Drupal 6 & Drupal 7 & stav  \\ \hline 
    Backup and Migrate & 2.7 & 2.7 & \checkmark \\ \hline
    Colorbox & 1.6 & 2.4 & \checkmark \\ \hline
    CCK & 2.9 & jádro & \checkmark \\ \hline
    Custom Breadcumbs & 1.5 & 1.x-alpha3 & \\ \hline
    DB Maintenance & 1.4 & 1.1 & \checkmark \\ \hline
    DHTML Menu & 3.5 & 1.0-beta1 & \\ \hline 
    Email Field & 1.4 & 1.2 & \checkmark \\ \hline
    File (Field Paths & 1.5 & 1.0-beta4 & \\ \hline
    FileField & 3.11 & jádro & \checkmark \\ \hline
    Front Page & 1.3 & 2.4 & \checkmark \\ \hline
    ImageAPI & 3.11 & jádro & \checkmark \\ \hline
    ImageCache & 2.0-rc1 & jádro & \checkmark \\ \hline
    IMCE & 2.5 & 1.7 & \checkmark \\ \hline
    IMCE Wysiwyg bridge & 1.1 & 1.0 & \checkmark \\ \hline
    jCarousel & 2.6 & 2.6 & \checkmark \\ \hline
    Link & 2.10 & 1.1 & \checkmark \\ \hline
    Localization Update & 2.10 & 1.1 & \checkmark \\ \hline
    Menu Attributes & 2.0-beta1 & 1.0-rc2 & \checkmark \\ \hline
    Menu Block & 2.4 & 2.3 & \checkmark \\ \hline
    Pathauto & 1.6 & 1.2 & \checkmark \\ \hline
    Taxonomy Breadcrumb & 1.1 & - & \\ \hline
    Token & 1.19 & 1.5 & \checkmark \\ \hline
    Transliteration & 3.1 & 3.1 & \checkmark \\ \hline
    Views & 2.16 & 3.7 & \\ \hline
    Views Search & 1.0 & - & \\ \hline
    WYSIWYG & 2.4 & 2.2 & \checkmark \\ \hline
  \end{tabular}
\end{table}

\subsection{Odebrané moduly}

\subsection{Nově přidané moduly a jejich popis}
Zde sepsat které moduly byly přidány a proč

\section{Téma vzhledu a jeho rozložení}

\section{Deployment a jeho možnosti}

\section{Optimalizace řešení a její dopad na uživatelskou zkušenost}
Ideálně si projít nějaké výzkumy Googlu ohledně odezvy a jejího dopadu na uživatele
Popsat agregaci JS, CSS a podobne 
\cite{website:drupal:optimizing}

\chapter{Implementace připojení ke vzdálené ploše}
\label{chap:implementace-guacamole}
Implementace připojení ke vzdálené ploše probíhala v několika fázích. Nejdříve bylo potřeba spustit řešení Guacamole lokálně a ujistit se, že je použitelné pro naše potřeby. Bylo také nutné analyzovat, jaké všechny možnosti poskytuje a které vlastnosti jsou potřebné a které přebytečné. Jako přebytečné byly idnetifikovány vlastnosti poskytující správu uživatelů, připojení a jejich skupin. Dále je implementována podpora klávesnici na obrazovce, ukládání snímků obrazovky a mnoho dalších rozšířených možností, které nebyly do základní verze vyžadovány a byly spíše kontraproduktivní s ohledem na zvýšení komplexnosti kódu a debugování celého řešení. 

Jakmile byla funkčnost ověřena, bylo nutné celou klientskou část řešení přesunout do modulu v Drupalu a upravit pro tamější podmínky. Bylo nutné změnit HTML výstup, kdy Drupal si v základu buduje strukturu pomocí několika šablonových souborů pro stránku, tělo a pod. Bylo nutné přidat JavaScriptové knihovny z Guacamole, odstranit nepotřebný kód a upravit vše k funkčnosti v prostředí s použitím CORS. 

Guacamole také poskytuje mnohá nastavení a pro ulehčení byla do modulu přidána administrační stránka, která přímo zapisuje do konfiguračního souboru Guacamole a tím eliminuje potřebu připojení na server. 

\section{Ostranění autentizace uživatelů a vytvoření vlastní autorizace}
Guacamole v základu poskytuje API pro správu uživatelských účtů a jejich připojení. Jsou implementovány dvě metody, jedna spoléhá na uložení dat do konfiguračního souboru, zatímco druhá pracuje s MySQL databází. Obě rozšiřují třídu \emph{SimpleAuthenticationProvider}, ke které přidávají potřebnou funkcionalitu. 

Pro potřeby tohoto projektu však bylo potřeba vždy pouze jediné připojení, pro jednotlivé uživatele se měnilo pouze jejich přihlašovací jméno. Byla vytvořena nová třída \emph{DrupalAuthenticationProvider}, která načítá adresu serveru a port přímo z konfiguračního souboru pro všechna připojení a vrací je Guacamole k dalšímu zpracování. 

Pro nastavení přihlašovacích údajů je potřeba se nejdříve k serveru přihlásit. Pro minimalizaci úkonů potřebných ke každému připojení ke vzdálené ploše a také k zjednodušení celého procesu si musí každý uživatel portálu uložit své přihlašovací údaje do svého profilu, odkud jsou pak použity při přihlášení ke Guacamole Servletu. K tomu je použito dvou služeb - \emph{connect} a {login}. Proces je znázorněn na diagramu \ref{fig:login_process}. 

Komunikace je započata přímo v klientském prohlížeči z JavaScriptu. Po přístupu na stránku /aspi je nejdříve kontaktována pomocí technolie AJAX stránka /aspi/ajax na portálu, která se připojí ke servletu Login. Guacamole Servlet si vytvoří nové \gls{session} a jeho identifikátor odešle zpět PHP kódu. Pokud vše proběhne v pořádku, je identifikátor sezení odeslán pomocí set-cookie hlavičky zpět stránce /aspi, kde si informaci uloží prohlížeč jako cookie pro pozdější komunikaci. V případě jakékoliv chyby je chybové hlášení vypsáno na obrazovce a zalogováno v systému bez jakýchkoliv dalších pokusů o připojení, uživatel je tedy nucen buď stránku obnovit, nebo kontaktovat správce stránek. Pokud však vše proběhne v pořádku, je inicializována smyčka přímých volání služby \emph{tunnel} poskytované Guacamole Servlet kontejnerem za pomocí technologie CORS. Komunikace probíhá za pomocí Guacamole protokolu a ten je poté konvertován na grafický výstup na obrazovce uživatele, který je od této chvíle schopen pomocí myši a klávesnice ovládat vzdálenou plochu a tím i ASPI.

\begin{figure}[]
  \includegraphics[scale=0.85]{img/login-process-crop.pdf}
  \caption{Proces připojení ke vzdálené ploše}
  \label{fig:login_process}
\end{figure}  

\section{Přesun JavaScript kódu a stylů do modulu Drupalu}
Pro ulehčení správy \gls{session}, které by jinak muselo být synchronizováno mezi dvěma stránkami, byl veškerý kód stránky z Guacamole JAVA projektu přesunut do modulu v drupalu. Do složky js/lib byly přesunuty všechny zdrojové kódy z knihovny Guacamole-js a byla vytvořena nová stránka /aspi poskytující stejnou funkcionalitu jako JAVA modul. Spolu s javascriptem bylo nutné přesunout i základní css styly pro zachování formátu vykreslování okna vzdálené plochy. Jak knihovny, tak styly jsou importovány pouze na stránce /aspi pro snížení náročnosti běhu celé platformy, která by jinak byla nucena načítat nepotřebné soubory. 

Drupal v základu vytváří komplexní html výstup včetně loga, základní struktury a podobně, kdežto guacamole vyžaduje pro vykreslení vzdálené plochy velmi jednoduchou strukturu obsahující prakticky jen plátno pro vykreslování výstupu a nastavení v hlavičce. Zatímco údaje do hlavičky lze přidat jednoduše pomocí implementace hook\_api drupalu (viz. sekce \ref{sec:technologies}), změnu výstupu bylo nutné implementovat pomocí kombinace několika technik. Téma vzhledu \emph{Omega} ve verzi 4.x poskytuje funkcionalitu rozdílných rozvržení (layouts) dostupných pro různé části stránky. Tato možnost lze skombinovat s modulem \emph{Context} a jeho podmodulem \emph{Context Omega}, který poskytuje přemostění mezi modulem a tématem vzhledu a tím i možnost změny rozvržení podle definovaných pravidel. V případě tohoto projektu stačilo nadefinovat pravidlo změny pro url /aspi na které se automaticky přepne rozvržení na minimalistické rozvržení nazvané \emph{Guacamole}. Toto nastavení je i exportováno do konfiguračního modulu esf\_feature.

\section{Implementace CORS}
Pro možnost komunikace mezi více doménami bylo potřeba implementovat CORS (viz. sekce \ref{sec:technologies}). Hlavní změna je u zpracování požadavků na straně serveru, k čemuž musela být do projektu přidána a nastavena knihovna k jeho zpracování. Pro JAVA EE byla využita knihovna CORS filter od [d]zhuvinov  [s]oftware\cite{website:cors-filter}, která tuto implementaci poskytuje ve formě knihovny. Na stránkách je i detailně popsáno nastavení a použití, kdy v připadě tohoto serveru bylo nutno omezit zdroj CORS požadavků na jedinou doménu a více nebylo nutno se o bezpečnost obávat.

Druhá část implementace je umožnění cross-domain požadavků v JavaScriptu. Knihovna Guacamole-js musela být lehce přepsána v místech, kde byla použita volání XMLHttpRequest, která jsou v tomto případě volána asynchronně. Použité řešení bohužel nelze aplikovat na \gls{ie}, neboť XDomainRequest nepodporuje asynchronní zpracování a bude nutné toto řešení ještě přepracovat do funkční podoby.

\section{Implementace úpravy nastavení z administrace portálu}
Guacamole typicky poskytuje nastavení pomocí konfiguračního souboru umístěného buď ve složce instalace, nebo v domácí složce uživatele, který program spouští. Jelikož je ke změně těchto konfiguračních souborů nutné přistupovat přímo k serveru, rozhodl jsem se tuto administrační část přepracovat a zpřístupnit přímo z administrace portálu. Ta nabízí dvě základní stránky. Na stránce Nastavení (/config/esf/settings) je možné upravit základní nastavení projektu jako je URL adresa pro připojení ke Guacamole Servlet službám či právě přístup ke konfiguračnímu souboru. Ten se typicky jmenuje guacamole.properties a nachází se ve složce /srv/guacamole/. Je nutné se ujistit, že jak Guacamole Servlet (TomCat) tak ESF Portál (Apache) mají k souboru přístup a mohou jej upravovat.

Na stránce nastavení Připojení ke vzdálené ploše (config/esf/remote) lze za předpokladu, že je vše správně nastaveno, upravovat nastavení Guacamole samotného a url pro připojení k serveru vzdálené plochy - což je v našem případě ASPI. Dále je nutné nastavit port pro připojení ke Guacd démonovi poskytujícímu proxy pro připojení ke vzdálené ploše, uživatelské jméno a heslo je však převzato z nastavení každého jednotlivého uživatele.

\section{Instalace a konfigurace řešení}
